#! bin/bash
# This script provides a generic deployment configuration base to initialize a server so it con be configured with puppet
#
# Author: pierre@pvln.nl
# Usage : sh ./deployment_base 
#
echo 0.0 Starting deployment_base ...

# ==========================================
# SET VARIABLES
# =========================================
#
# no spaces in variables!
#
MYDEPLOYMENTUSERNAME="myDep"
MYDEPLOYMENTPASSWORD="myDep"
MYDEPLOYMENTDIRECTORY=/home/$MYDEPLOYMENTUSERNAME

echo 1.0 Deployment user ...
# ==========================================
# DEPLOYMENT USER AND GROUP
# ==========================================
echo 1.1 Checking if deployment user $MYDEPLOYMENTUSERNAME exists if not create it ...
[[ $(cat /etc/passwd | grep $MYDEPLOYMENTUSERNAME | sed -e 's/:.*//g') =~ $MYDEPLOYMENTUSERNAME ]] ||  sudo useradd -m $MYDEPLOYMENTUSERNAME -p $MYDEPLOYMENTPASSWORD

echo 1.2 Checking if directory $MYDEPLOYMENTDIRECTORY exists if not create it ...
#
# Inspiration: https://unix.stackexchange.com/questions/247576/how-to-get-home-given-user
#              https://stackoverflow.com/questions/42979293/creating-a-home-directory-for-a-user
#
#[[ $(getent passwd $MYDEPLOYMENTUSERNAME | cut -d: -f6) == "" ]] || sudo mkdir /home/$MYDEPLOYMENTUSERNAME && sudo usermod -d /home/$MYDEPLOYMENTUSERNAME $MYDEPLOYMENTUSERNAME
if [ ! -d "$MYDEPLOYMENTDIRECTORY" ]; then
  sudo mkdir "$MYDEPLOYMENTDIRECTORY"
fi
echo 1.3 Setting ownership of dirctory $MYDEPLOYMENTDIRECTORY to $MYDEPLOYMENTUSERNAME ...
sudo chown $MYDEPLOYMENTUSERNAME:$MYDEPLOYMENTUSERNAME $MYDEPLOYMENTDIRECTORY

echo 1.5 Adding user to sudo group
sudo usermod -aG sudo $MYDEPLOYMENTUSERNAME

echo 2.0 Timezone ...
# ==========================================
# CONFIGURE TIMEZONE AND LOCALTIME
# ==========================================
#
# Inspiration: https://www.tecmint.com/set-time-timezone-and-synchronize-time-using-timedatectl-command/
#              https://stackoverflow.com/questions/12375722/how-do-i-test-in-one-line-if-command-output-contains-a-certain-string/12375792
#              https://stackoverflow.com/questions/12230690/string-comparison-in-bash-not-found/12230723
#
echo 2.1 Check if timezone is Europe/Amsterdam if not change it ...
[[ $(timedatectl | grep "Time zone") =~ "Europe/Amsterdam" ]] || sudo timedatectl set-timezone "Europe/Amsterdam"


echo 3.0 Required Programs
# ==========================================
# PROGRAMS
# ==========================================
#
cd /home/$MYDEPLOYMENTUSERNAME
ls -l


echo 4.0 Deployment base created ...
